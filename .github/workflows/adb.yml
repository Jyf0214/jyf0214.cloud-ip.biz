# å·¥ä½œæµåç§°
name: CI with Android Emulator (Using Professional Action)

# å·¥ä½œæµè§¦å‘å™¨
on:
  workflow_dispatch:
    inputs:
      # --- æ ¸å¿ƒæ§åˆ¶å¼€å…³ ---
      enable_ssh_debug: { description: 'ğŸ [è°ƒè¯•] æ˜¯å¦å¯ç”¨SSHæ‰‹åŠ¨è°ƒè¯• (å°†æš‚åœè‡ªåŠ¨åŒ–)?', required: true, type: boolean, default: false }

      # --- å®‰å“æ¨¡æ‹Ÿå™¨é…ç½® ---
      avd_name: { description: 'AVD (æ¨¡æ‹Ÿå™¨) åç§°', required: true, type: string, default: 'pixel_6_pro' }
      api_level: { description: 'å®‰å“ API ç­‰çº§ (ä¾‹å¦‚: 29, 30, 33)', required: true, type: string, default: '33' }
      target: { description: 'ç³»ç»Ÿé•œåƒç±»å‹ (google_apis, default)', required: true, type: string, default: 'google_apis' }
      arch: { description: 'CPU æ¶æ„ (x86_64, x86)', required: true, type: string, default: 'x86_64' }

# å¹¶å‘æ§åˆ¶
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  # æ³¨æ„ï¼šè¿™äº›å˜é‡ç°åœ¨ä¸»è¦ç»™ ngrok å’Œæˆ‘ä»¬è‡ªå·±å‚è€ƒï¼Œæ¨¡æ‹Ÿå™¨ Action ä¼šç›´æ¥ä½¿ç”¨ inputs
  AVD_NAME: ${{ github.event.inputs.avd_name }}
  API_LEVEL: ${{ github.event.inputs.api_level }}
  NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}

jobs:
  build-and-run-android:
    name: "Run Android Emulator via Professional Action"
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # Java (JDK) æ˜¯å®‰å“æ¨¡æ‹Ÿå™¨çš„å‰æä¾èµ–
      - name: 2. è®¾ç½® Java ç¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17' # æ¨èä½¿ç”¨è¾ƒæ–°çš„ JDK ç‰ˆæœ¬

      - name: 3. âœ… [æ ¸å¿ƒ] å¯åŠ¨å®‰å“æ¨¡æ‹Ÿå™¨
        uses: reactivecircus/android-emulator-runner@v2
        with:
          # --- ä¼ å…¥æˆ‘ä»¬çš„é…ç½® ---
          api-level: ${{ env.API_LEVEL }}
          target: ${{ github.event.inputs.target }}
          arch: ${{ github.event.inputs.arch }}
          avd-name: ${{ env.AVD_NAME }}
          
          # --- Action æ ¸å¿ƒé…ç½® ---
          script: adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done;' # ç­‰å¾…æ¨¡æ‹Ÿå™¨å®Œå…¨å¯åŠ¨åï¼Œæ­¤æ­¥éª¤æ‰ç®—å®Œæˆ
          # æ¨¡æ‹Ÿå™¨å°†åœ¨åå°ç»§ç»­è¿è¡Œï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨

      - name: 4. æš´éœ²æ— çº¿ADB (ngrok)
        id: start_ngrok
        run: |
          echo "âœ… æ¨¡æ‹Ÿå™¨å·²ç”±ä¸Šä¸€æ­¥æˆåŠŸå¯åŠ¨å¹¶è¿è¡Œåœ¨åå°ã€‚"
          adb devices

          echo "--- å¯åŠ¨ ngrok éš§é“æš´éœ² ADB ç«¯å£ (5555) ---"
          wget -q https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip -O ngrok.zip
          unzip ngrok.zip
          chmod +x ./ngrok
          ./ngrok authtoken ${{ env.NGROK_AUTHTOKEN }}
          
          # åœ¨åå°å¯åŠ¨ ngrok å¹¶å°†è¿æ¥ä¿¡æ¯è¾“å‡ºåˆ°æ–‡ä»¶
          ./ngrok tcp 5555 --log=stdout > ngrok.log &
          sleep 5 # ç­‰å¾… ngrok å¯åŠ¨

          NGROK_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[] | select(.proto == "tcp") | .public_url')

          echo "================================================================"
          echo "âœ… æ— çº¿ ADB å·²å°±ç»ª!"
          echo "è¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä»æ‚¨çš„æœ¬åœ°è®¡ç®—æœºè¿æ¥:"
          echo "   adb connect ${NGROK_URL#tcp://}"
          echo "================================================================"
          echo "adb_connect_command=adb connect ${NGROK_URL#tcp://}" >> $GITHUB_OUTPUT

      - name: 5A. [è‡ªåŠ¨åŒ–è·¯å¾„] æš‚åœå·¥ä½œæµ
        if: github.event.inputs.enable_ssh_debug == 'false'
        run: |
          echo "è‡ªåŠ¨åŒ–è¿è¡Œæ¨¡å¼ã€‚å·¥ä½œæµå°†æš‚åœ 350 åˆ†é’Ÿ..."
          sleep 350m
          echo "â³ è§„å®šè¿è¡Œæ—¶é—´å·²åˆ°ã€‚"

      - name: 5B. [è°ƒè¯•è·¯å¾„] å¯ç”¨ SSH
        if: github.event.inputs.enable_ssh_debug == 'true'
        uses: lhotari/action-upterm@v1
        with:
          limit-access-to-actor: true
          wait-timeout-minutes: 350

      - name: 6. [æ¸…ç†] å…³é—­æ¨¡æ‹Ÿå™¨å’Œéš§é“
        if: always()
        run: |
          echo "--- æ­£åœ¨å…³é—­æ¨¡æ‹Ÿå™¨å’Œ ngrok éš§é“ ---"
          adb emu kill || echo "æ¨¡æ‹Ÿå™¨å¯èƒ½å·²å…³é—­ã€‚"
          killall ngrok || echo "ngrok è¿›ç¨‹æœªæ‰¾åˆ°ã€‚"
          echo "âœ… æ¸…ç†å®Œæˆã€‚"