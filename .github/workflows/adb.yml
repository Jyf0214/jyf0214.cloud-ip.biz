# å·¥ä½œæµåç§°
name: CI with Android Emulator (Ephemeral - No Backup)

# å·¥ä½œæµè§¦å‘å™¨
on:
  workflow_dispatch:
    inputs:
      # --- æ ¸å¿ƒæ§åˆ¶å¼€å…³ ---
      enable_ssh_debug: { description: 'ğŸ [è°ƒè¯•] æ˜¯å¦å¯ç”¨SSHæ‰‹åŠ¨è°ƒè¯• (å°†æš‚åœè‡ªåŠ¨åŒ–)?', required: true, type: boolean, default: false }

      # --- å®‰å“æ¨¡æ‹Ÿå™¨é…ç½® ---
      avd_name: { description: 'AVD (æ¨¡æ‹Ÿå™¨) åç§°', required: true, type: string, default: 'pixel_6_pro' }
      api_level: { description: 'å®‰å“ API ç­‰çº§ (ä¾‹å¦‚: 30, 31, 33)', required: true, type: string, default: '33' }
      target: { description: 'ç³»ç»Ÿé•œåƒç±»å‹ (google_apis, default, etc.)', required: true, type: string, default: 'google_apis' }
      arch: { description: 'CPU æ¶æ„ (x86_64, arm64-v8a)', required: true, type: string, default: 'x86_64' }

# å¹¶å‘æ§åˆ¶
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  AVD_NAME: ${{ github.event.inputs.avd_name }}
  API_LEVEL: ${{ github.event.inputs.api_level }}
  TARGET: ${{ github.event.inputs.target }}
  ARCH: ${{ github.event.inputs.arch }}
  ANDROID_SDK_ROOT: "${{ github.workspace }}/android-sdk"
  AVD_HOME: "${{ github.workspace }}/avd_home"
  NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}

jobs:
  build-and-run-android:
    name: "Run Fresh Android Emulator"
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: 2. æœ€å¤§åŒ–è¿è¡Œå™¨ç£ç›˜ç©ºé—´
        run: |
          echo "Maximizing runner disk space..."
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY"

      - name: 3. å®‰è£…æ‰€éœ€ä¾èµ–
        run: |
          echo "Installing dependencies: qemu-kvm, openjdk..."
          sudo apt-get update
          sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils unzip openjdk-11-jdk jq
          echo "Verifying KVM acceleration..."
          sudo kvm-ok

      - name: 4. å®‰è£…ã€éªŒè¯å¹¶åˆ›å»ºæ¨¡æ‹Ÿå™¨ (ç»ˆæä¿®æ­£ç‰ˆ)
        run: |
          echo "1. åˆ›å»ºç›®å½•..."
          mkdir -p ${{ env.AVD_HOME }}
          mkdir -p ${{ env.ANDROID_SDK_ROOT }}/cmdline-tools/latest

          echo "2. ä¸‹è½½å¹¶å®‰è£… Android SDK å‘½ä»¤è¡Œå·¥å…·..."
          CMDLINE_TOOLS_URL="https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip"
          wget -q -O /tmp/cmdline-tools.zip ${CMDLINE_TOOLS_URL}
          unzip -q -d ${{ env.ANDROID_SDK_ROOT }}/cmdline-tools/latest /tmp/cmdline-tools.zip
          mv ${{ env.ANDROID_SDK_ROOT }}/cmdline-tools/latest/cmdline-tools/* ${{ env.ANDROID_SDK_ROOT }}/cmdline-tools/latest/
          rm -rf ${{ env.ANDROID_SDK_ROOT }}/cmdline-tools/latest/cmdline-tools /tmp/cmdline-tools.zip

          echo "3. è®¾ç½®å…¨å±€ PATH å¹¶æ¥å—è®¸å¯..."
          # FIX: ä½¿ç”¨ GITHUB_ENVï¼Œè®© PATH åœ¨æ‰€æœ‰åç»­æ­¥éª¤ä¸­éƒ½å¯ç”¨
          echo "PATH=${{ env.ANDROID_SDK_ROOT }}/cmdline-tools/latest/bin:${{ env.ANDROID_SDK_ROOT }}/platform-tools:${{ env.ANDROID_SDK_ROOT }}/emulator:$PATH" >> $GITHUB_ENV
          yes | sdkmanager --licenses

          echo "4. [åˆ†è§£å®‰è£…] é€ä¸ªå®‰è£…æ ¸å¿ƒåŒ…..."
          sdkmanager "platform-tools" --verbose
          sdkmanager "emulator" --verbose
          sdkmanager "system-images;android-${{ env.API_LEVEL }};${{ env.TARGET }};${{ env.ARCH }}" --verbose
          
          echo "5. [å¼ºåŠ›éªŒè¯] æ£€æŸ¥ç³»ç»Ÿé•œåƒçš„å®Œæ•´æ€§..."
          SYSTEM_IMAGE_PATH="${{ env.ANDROID_SDK_ROOT }}/system-images/android-${{ env.API_LEVEL }}/${{ env.TARGET }}/${{ env.ARCH }}"
          KERNEL_PATH="${SYSTEM_IMAGE_PATH}/kernel-ranchu"

          echo "--- å°†åˆ—å‡ºç³»ç»Ÿé•œåƒç›®å½•çš„å…¨éƒ¨å†…å®¹ä»¥ä¾›è°ƒè¯• ---"
          ls -lR "$SYSTEM_IMAGE_PATH"
          echo "-------------------------------------------"

          if [ ! -f "$KERNEL_PATH" ]; then
            echo "::error::è‡´å‘½é”™è¯¯ï¼šå†…æ ¸æ–‡ä»¶ '$KERNEL_PATH' æœªæ‰¾åˆ°ï¼"
            echo "::error::è¿™è¡¨æ˜ç³»ç»Ÿé•œåƒæœªèƒ½æˆåŠŸå®‰è£…ã€‚è¯·ä»”ç»†æ£€æŸ¥ä¸Šé¢ 'ls -lR' çš„è¾“å‡ºå’Œ sdkmanager çš„æ—¥å¿—ã€‚"
            exit 1
          fi
          echo "âœ… å†…æ ¸æ–‡ä»¶éªŒè¯æˆåŠŸã€‚"

          echo "6. åˆ›å»ºå…¨æ–°çš„ AVD..."
          echo "no" | avdmanager --verbose create avd -n "${{ env.AVD_NAME }}" -k "system-images;android-${{ env.API_LEVEL }};${{ env.TARGET }};${{ env.ARCH }}" --device "pixel_6_pro" --path "${{ env.AVD_HOME }}/${{ env.AVD_NAME }}.avd"
          
          echo "--- âœ… å…¨æ–°æ¨¡æ‹Ÿå™¨ç¯å¢ƒå·²å‡†å¤‡å°±ç»ª ---"

      - name: 5. å¯åŠ¨å®‰å“æ¨¡æ‹Ÿå™¨ & æš´éœ²æ— çº¿ADB
        id: start_emulator
        run: |
          # æ³¨æ„ï¼šæ­¤æ­¥éª¤æ— éœ€å† export PATHï¼Œå› ä¸ºå®ƒå·²ç”±ä¸Šä¸€æ­¥çš„ GITHUB_ENV è®¾ç½®
          export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:${{ env.ANDROID_SDK_ROOT }}/emulator/lib64:${{ env.ANDROID_SDK_ROOT }}/emulator/lib64/qt/lib

          echo "--- å¯åŠ¨å®‰å“æ¨¡æ‹Ÿå™¨ (åå°è¿è¡Œ) ---"
          emulator -sysdir "${{ env.ANDROID_SDK_ROOT }}" -avd "${{ env.AVD_NAME }}" -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect &

          echo "--- ç­‰å¾…æ¨¡æ‹Ÿå™¨å®Œå…¨å¯åŠ¨ ---"
          adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done;'
          adb devices
          echo "âœ… æ¨¡æ‹Ÿå™¨å·²å¯åŠ¨å¹¶å‡†å¤‡å°±ç»ªã€‚"

          echo "--- å¯åŠ¨ ngrok éš§é“æš´éœ² ADB ç«¯å£ (5555) ---"
          wget -q https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip -O ngrok.zip
          unzip ngrok.zip
          chmod +x ./ngrok
          ./ngrok authtoken ${{ env.NGROK_AUTHTOKEN }}
          ./ngrok tcp 5555 --log=stdout > ngrok.log &
          sleep 5 

          NGROK_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[] | select(.proto == "tcp") | .public_url')

          echo "================================================================"
          echo "âœ… æ— çº¿ ADB å·²å°±ç»ª!"
          echo "è¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä»æ‚¨çš„æœ¬åœ°è®¡ç®—æœºè¿æ¥:"
          echo "   adb connect ${NGROK_URL#tcp://}"
          echo "================================================================"
          echo "adb_connect_command=adb connect ${NGROK_URL#tcp://}" >> $GITHUB_OUTPUT

      - name: 6A. [è‡ªåŠ¨åŒ–è·¯å¾„] æš‚åœå·¥ä½œæµ
        if: github.event.inputs.enable_ssh_debug == 'false'
        run: |
          echo "è‡ªåŠ¨åŒ–è¿è¡Œæ¨¡å¼ã€‚å·¥ä½œæµå°†æš‚åœ 350 åˆ†é’Ÿ..."
          sleep 350m
          echo "â³ è§„å®šè¿è¡Œæ—¶é—´å·²åˆ°ã€‚"

      - name: 6B. [è°ƒè¯•è·¯å¾„] å¯ç”¨ SSH
        if: github.event.inputs.enable_ssh_debug == 'true'
        uses: lhotari/action-upterm@v1
        with:
          limit-access-to-actor: true
          wait-timeout-minutes: 350

      - name: 7. [æ¸…ç†] å…³é—­æ¨¡æ‹Ÿå™¨å’Œéš§é“
        if: always()
        run: |
          echo "--- æ­£åœ¨å…³é—­æ¨¡æ‹Ÿå™¨å’Œ ngrok éš§é“ ---"
          adb emu kill || echo "æ¨¡æ‹Ÿå™¨å¯èƒ½å·²å…³é—­ã€‚"
          killall ngrok || echo "ngrok è¿›ç¨‹æœªæ‰¾åˆ°ã€‚"
          echo "âœ… æ¸…ç†å®Œæˆã€‚"

      - name: 8. æ¸…ç†è¿è¡Œå™¨æ®‹ç•™æ–‡ä»¶
        if: always()
        run: |
          echo "--- å¼€å§‹æ¸…ç†è¿è¡Œå™¨ç¯å¢ƒ ---"
          rm -rf ${{ env.ANDROID_SDK_ROOT }} ${{ env.AVD_HOME }} ngrok ngrok.zip ngrok.log
          echo "âœ… è¿è¡Œå™¨æ¸…ç†å®Œæˆã€‚"