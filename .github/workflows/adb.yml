# å·¥ä½œæµåç§°
name: Windows Remote Session (RDP via Ngrok)

# å·¥ä½œæµè§¦å‘å™¨
on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

# å…¨å±€ç¯å¢ƒå˜é‡ - ç”¨äºå­˜å‚¨å‡­æ®
env:
  RDP_USER: ${{ secrets.RDP_USER }}
  RDP_PASS: ${{ secrets.RDP_PASS }}
  NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}

jobs:
  rdp-session:
    name: "ğŸš€ å¯åŠ¨ Windows è¿œç¨‹æ¡Œé¢ä¼šè¯"
    runs-on: windows-latest # å…³é”®æ”¹åŠ¨ï¼šä½¿ç”¨ Windows è¿è¡Œå™¨
    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: 2. å‡†å¤‡ç¯å¢ƒå¹¶è®¾ç½® RDP è´¦æˆ·
        run: |
          echo "æ­£åœ¨ä¸º RDP åˆ›å»ºç”¨æˆ·è´¦æˆ·..."
          net user /add "${{ env.RDP_USER }}" "${{ env.RDP_PASS }}"
          net localgroup "Remote Desktop Users" "${{ env.RDP_USER }}" /add
          echo "âœ… RDP è´¦æˆ·å·²è®¾ç½®ã€‚"

      - name: 3. å¯ç”¨è¿œç¨‹æ¡Œé¢å¹¶é…ç½®é˜²ç«å¢™
        run: |
          echo "æ­£åœ¨å¯ç”¨è¿œç¨‹æ¡Œé¢æœåŠ¡..."
          reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          echo "æ­£åœ¨é…ç½®é˜²ç«å¢™ä»¥å…è®¸ RDP è¿æ¥..."
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          echo "âœ… RDP æœåŠ¡åŠé˜²ç«å¢™å·²é…ç½®ã€‚"

      - name: 4. ğŸ¤« ä¸‹è½½å¹¶å¯åŠ¨ Ngrok å†…ç½‘ç©¿é€
        run: |
          echo "æ­£åœ¨ä¸‹è½½ Ngrok..."
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile "ngrok.zip"
          Expand-Archive ngrok.zip
          
          echo "æ­£åœ¨é…ç½® Ngrok Authtoken..."
          ./ngrok.exe config add-authtoken "${{ env.NGROK_AUTHTOKEN }}"
          
          echo "âœ… æ­£åœ¨åå°å¯åŠ¨ Ngrok TCP éš§é“..."
          Start-Process -NoNewWindow ./ngrok.exe "tcp 3389"
          
          # ç­‰å¾…å‡ ç§’é’Ÿè®© Ngrok å¯åŠ¨å¹¶ç”Ÿæˆ URL
          Start-Sleep -Seconds 5
          
          echo "â³ Ngrok éš§é“å·²å¯åŠ¨ã€‚è¯·æ£€æŸ¥ä¸‹æ–¹çš„æ—¥å¿—è·å–è¿æ¥åœ°å€ã€‚"

      - name: 5. æ˜¾ç¤ºè¿æ¥ä¿¡æ¯å¹¶ä¿æŒä¼šè¯
        run: |
          echo "æ­£åœ¨è·å– Ngrok æä¾›çš„è¿æ¥åœ°å€..."
          # ä½¿ç”¨ curl è°ƒç”¨ Ngrok æœ¬åœ° API è·å–éš§é“ä¿¡æ¯
          $tunnelInfo = curl.exe http://127.0.0.1:4040/api/tunnels
          $rdpUrl = ($tunnelInfo | ConvertFrom-Json).tunnels[0].public_url
          
          echo "========================================================================="
          echo "âœ… è¿œç¨‹æ¡Œé¢å·²å°±ç»ª!"
          echo "è¯·ä½¿ç”¨ä»¥ä¸‹ä¿¡æ¯è¿æ¥:"
          echo "   åœ°å€ (Address):   $($rdpUrl.replace('tcp://',''))"
          echo "   ç”¨æˆ·å (Username): ${{ env.RDP_USER }}"
          echo "   å¯†ç  (Password):   [è¯·æŸ¥çœ‹æ‚¨åœ¨ä»“åº“ä¸­è®¾ç½®çš„ RDP_PASS Secret]"
          echo "========================================================================="
          
          echo "å·¥ä½œæµå°†æš‚åœçº¦ 6 å°æ—¶ä»¥ä¿æŒä¼šè¯ã€‚ç»“æŸåè¯·æ‰‹åŠ¨åœæ­¢å·¥ä½œæµæˆ–ç­‰å¾…è¶…æ—¶ã€‚"
          Start-Sleep -Seconds 21000 # ä¿æŒè¿è¡Œï¼Œæ¥è¿‘ GitHub Actions çš„æœ€é•¿ä½œä¸šæ—¶é—´ (6å°æ—¶)