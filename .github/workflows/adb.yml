# å·¥ä½œæµåç§°
name: CI with Android Emulator (For Non-KVM Environments)

# å·¥ä½œæµè§¦å‘å™¨
on:
  workflow_dispatch:
    inputs:
      # --- æ ¸å¿ƒæ§åˆ¶å¼€å…³ ---
      enable_ssh_debug: { description: 'ğŸ [è°ƒè¯•] æ˜¯å¦å¯ç”¨SSHæ‰‹åŠ¨è°ƒè¯• (å°†æš‚åœè‡ªåŠ¨åŒ–)?', required: true, type: boolean, default: false }

      # --- å®‰å“æ¨¡æ‹Ÿå™¨é…ç½® ---
      api_level: { description: 'å®‰å“ API ç­‰çº§ (ä¾‹å¦‚: 29, 30, 33)', required: true, type: string, default: '33' }
      target: { description: 'ç³»ç»Ÿé•œåƒç±»å‹ (google_apis, default)', required: true, type: string, default: 'google_apis' }
      arch: { description: 'CPU æ¶æ„ (x86_64, x86)', required: true, type: string, default: 'x86_64' }

# å¹¶å‘æ§åˆ¶
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  API_LEVEL: ${{ github.event.inputs.api_level }}
  NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}

jobs:
  build-and-run-android:
    name: "Run Android Emulator in Non-KVM Environment"
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: 2. è®¾ç½® Java ç¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 3. âœ… [æ ¸å¿ƒ] å¯åŠ¨å®‰å“æ¨¡æ‹Ÿå™¨ (å·²é€‚é…æ— ç¡¬ä»¶åŠ é€Ÿç¯å¢ƒ)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          # --- åŸºç¡€é…ç½® ---
          api-level: ${{ env.API_LEVEL }}
          target: ${{ github.event.inputs.target }}
          arch: ${{ github.event.inputs.arch }}
          
          # --- é’ˆå¯¹æ—  KVM ç¯å¢ƒçš„ä¼˜åŒ–é…ç½® ---
          emulator-options: "-no-window -no-snapshot -no-audio -no-boot-anim -gpu swiftshader_indirect"
          
          # --- å¢åŠ å¯åŠ¨è„šæœ¬çš„è¶…æ—¶æ—¶é—´ ---
          script-timeout: 900 # å¢åŠ åˆ° 15 åˆ†é’Ÿ (900ç§’)
          
          # --- ç­‰å¾…æ¨¡æ‹Ÿå™¨å®Œå…¨å¯åŠ¨çš„è„šæœ¬ ---
          script: adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do echo "waiting for boot..."; sleep 5; done; input keyevent 82'

      - name: 4. æš´éœ²æ— çº¿ADB (ngrok)
        id: start_ngrok
        run: |
          echo "âœ… æ¨¡æ‹Ÿå™¨å·²ç”±ä¸Šä¸€æ­¥æˆåŠŸå¯åŠ¨å¹¶è¿è¡Œåœ¨åå°ã€‚"
          adb devices

          echo "--- å¯åŠ¨ ngrok éš§é“æš´éœ² ADB ç«¯å£ (5555) ---"
          wget -q https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip -O ngrok.zip
          unzip ngrok.zip
          chmod +x ./ngrok
          ./ngrok authtoken ${{ env.NGROK_AUTHTOKEN }}
          
          ./ngrok tcp 5555 --log=stdout > ngrok.log &
          sleep 5 

          NGROK_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[] | select(.proto == "tcp") | .public_url')

          echo "================================================================"
          echo "âœ… æ— çº¿ ADB å·²å°±ç»ª!"
          echo "è¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä»æ‚¨çš„æœ¬åœ°è®¡ç®—æœºè¿æ¥:"
          echo "   adb connect ${NGROK_URL#tcp://}"
          echo "================================================================"
          echo "adb_connect_command=adb connect ${NGROK_URL#tcp://}" >> $GITHUB_OUTPUT

      - name: 5A. [è‡ªåŠ¨åŒ–è·¯å¾„] æš‚åœå·¥ä½œæµ
        if: github.event.inputs.enable_ssh_debug == 'false'
        run: |
          echo "è‡ªåŠ¨åŒ–è¿è¡Œæ¨¡å¼ã€‚å·¥ä½œæµå°†æš‚åœ 350 åˆ†é’Ÿ..."
          sleep 350m
          echo "â³ è§„å®šè¿è¡Œæ—¶é—´å·²åˆ°ã€‚"

      - name: 5B. [è°ƒè¯•è·¯å¾„] å¯ç”¨ SSH
        if: github.event.inputs.enable_ssh_debug == 'true'
        uses: lhotari/action-upterm@v1
        with:
          limit-access-to-actor: true
          wait-timeout-minutes: 350

      - name: 6. [æ¸…ç†] å…³é—­æ¨¡æ‹Ÿå™¨å’Œéš§é“
        if: always()
        run: |
          echo "--- æ­£åœ¨å…³é—­æ¨¡æ‹Ÿå™¨å’Œ ngrok éš§é“ ---"
          adb emu kill || echo "æ¨¡æ‹Ÿå™¨å¯èƒ½å·²å…³é—­ã€‚"
          killall ngrok || echo "ngrok è¿›ç¨‹æœªæ‰¾åˆ°ã€‚"
          echo "âœ… æ¸…ç†å®Œæˆã€‚"