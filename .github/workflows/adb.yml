# 工作流名称
name: Windows Remote Session (RDP via Ngrok)

# 工作流触发器
on:
  workflow_dispatch: # 允许手动触发

# 全局环境变量 - 用于存储凭据
env:
  RDP_USER: ${{ secrets.RDP_USER }}
  RDP_PASS: ${{ secrets.RDP_PASS }}
  NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}

jobs:
  rdp-session:
    name: "🚀 启动 Windows 远程桌面会话"
    runs-on: windows-latest # 关键改动：使用 Windows 运行器
    steps:
      - name: 1. 检出代码
        uses: actions/checkout@v4

      - name: 2. 准备环境并设置 RDP 账户
        run: |
          echo "正在为 RDP 创建用户账户..."
          net user /add "${{ env.RDP_USER }}" "${{ env.RDP_PASS }}"
          net localgroup "Remote Desktop Users" "${{ env.RDP_USER }}" /add
          echo "✅ RDP 账户已设置。"

      - name: 3. 启用远程桌面并配置防火墙
        run: |
          echo "正在启用远程桌面服务..."
          reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          echo "正在配置防火墙以允许 RDP 连接..."
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          echo "✅ RDP 服务及防火墙已配置。"

      - name: 4. 🤫 下载并启动 Ngrok 内网穿透
        run: |
          echo "正在下载 Ngrok..."
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile "ngrok.zip"
          Expand-Archive ngrok.zip
          
          echo "正在配置 Ngrok Authtoken..."
          ./ngrok.exe config add-authtoken "${{ env.NGROK_AUTHTOKEN }}"
          
          echo "✅ 正在后台启动 Ngrok TCP 隧道..."
          Start-Process -NoNewWindow ./ngrok.exe "tcp 3389"
          
          # 等待几秒钟让 Ngrok 启动并生成 URL
          Start-Sleep -Seconds 5
          
          echo "⏳ Ngrok 隧道已启动。请检查下方的日志获取连接地址。"

      - name: 5. 显示连接信息并保持会话
        run: |
          echo "正在获取 Ngrok 提供的连接地址..."
          # 使用 curl 调用 Ngrok 本地 API 获取隧道信息
          $tunnelInfo = curl.exe http://127.0.0.1:4040/api/tunnels
          $rdpUrl = ($tunnelInfo | ConvertFrom-Json).tunnels[0].public_url
          
          echo "========================================================================="
          echo "✅ 远程桌面已就绪!"
          echo "请使用以下信息连接:"
          echo "   地址 (Address):   $($rdpUrl.replace('tcp://',''))"
          echo "   用户名 (Username): ${{ env.RDP_USER }}"
          echo "   密码 (Password):   [请查看您在仓库中设置的 RDP_PASS Secret]"
          echo "========================================================================="
          
          echo "工作流将暂停约 6 小时以保持会话。结束后请手动停止工作流或等待超时。"
          Start-Sleep -Seconds 21000 # 保持运行，接近 GitHub Actions 的最长作业时间 (6小时)