# 工作流名称
name: Run OpenList and Veiled Journeys Downloader

# 工作流触发器：手动触发 (workflow_dispatch)
on:
  workflow_dispatch:

# 全局环境变量
env:
  CHROOT_DIR: /mnt/minisys
  BACKUP_FILE: minisys_backup.tar.gz
  WEBDAV_REMOTE_PATH: "backup"
  PAT: ${{ secrets.YUNZAIBOT_PAT }} 

# 作业定义
jobs:
  build-and-run:
    # 运行环境
    runs-on: ubuntu-latest
    
    # 作业步骤
    steps:
      - name: 1. 最大化运行器磁盘空间 (Maximize runner disk space)
        run: |
          echo "清理前，初始磁盘空间："
          df -h /
          echo "开始清理预装软件以释放空间..."
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY"
          echo "✅ 清理完成，当前可用空间："
          df -h /

      - name: 2. 安装所需依赖 (Install dependencies)
        run: |
          echo "正在安装 rclone 和 pigz (用于多线程压缩)..."
          sudo apt-get update
          sudo apt-get install -y rclone pigz
          pip install --upgrade pip
          pip install requests tqdm py7zr webdavclient3 rarfile
          echo "✅ 依赖安装完毕。"

      - name: 3. 克隆下载器仓库 (Clone Downloader Repository)
        run: git clone https://x-access-token:${PAT}@github.com/Jyf0214/veiled-journeys.git

      - name: 4. 运行 Kemono 下载器 (Run Kemono Downloader)
        run: |
          echo "正在运行 Kemono 下载器..."
          python veiled-journeys/oplist-kemono_downloader.py
          echo "✅ Kemono 下载器执行完毕。"