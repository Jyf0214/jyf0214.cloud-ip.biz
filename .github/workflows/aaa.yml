name: Incus CI with macvlan + WebDAV Backup + DNS fix

on:
  workflow_dispatch:

env:
  CONTAINER_NAME: my-ci-container
  BACKUP_FILE: incus_backup.tar.gz
  WEBDAV_REMOTE: webdav_backup

jobs:
  build-and-debug:
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone incus

      - name: Initialize Incus
        run: sudo incus admin init --auto

      - name: Configure rclone for WebDAV
        run: |
          mkdir -p ~/.config/rclone
          cat <<EOF > ~/.config/rclone/rclone.conf
          [${WEBDAV_REMOTE}]
          type = webdav
          url = ${{ secrets.WEBDAV_URL }}
          vendor = other
          user = ${{ secrets.WEBDAV_USER }}
          pass = $(echo '${{ secrets.WEBDAV_PASS }}' | rclone obscure -)
          EOF

      - name: Check, Restore or Create Container with macvlan
        run: |
          if [ -n "$(rclone lsf ${WEBDAV_REMOTE}:/ --include ${BACKUP_FILE})" ]; then
            rclone copy ${WEBDAV_REMOTE}:${BACKUP_FILE} .
            sudo incus import ${BACKUP_FILE} ${CONTAINER_NAME}
          else
            sudo incus launch images:ubuntu/22.04 ${CONTAINER_NAME}
          fi

          sudo incus config device add ${CONTAINER_NAME} eth0 nic \
            nictype=macvlan parent=eth0

          sudo incus start ${CONTAINER_NAME}

          sleep 5

          echo "Inject DNS servers..."
          sudo incus exec ${CONTAINER_NAME} -- bash -c 'echo -e "nameserver 8.8.8.8\nnameserver 1.1.1.1" > /etc/resolv.conf'

          sudo incus exec ${CONTAINER_NAME} -- apt-get update

      - name: Enable Upterm debugging
        uses: lhotari/action-upterm@v1
        with:
          limit-access-to-actor: true
          wait-timeout-minutes: 348

      - name: Stop and Backup Container
        run: |
          sudo incus stop ${CONTAINER_NAME} --force
          sudo incus export ${CONTAINER_NAME} ${BACKUP_FILE} --force
          rclone copyto ${BACKUP_FILE} ${WEBDAV_REMOTE}:${BACKUP_FILE}