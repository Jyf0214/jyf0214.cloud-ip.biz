name: Incus CI with SSH and WebDAV Backup (Host Networking - Final Syntax)

on:
  workflow_dispatch:

env:
  CONTAINER_NAME: my-ci-container
  BACKUP_FILE: incus_backup.tar.gz
  WEBDAV_REMOTE: webdav_backup

jobs:
  build-and-debug:
    runs-on: ubuntu-latest

    steps:
      # 1. 安装依赖
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone
          sudo curl -fsSL https://pkgs.zabbly.com/key.asc | sudo gpg --dearmor -o /usr/share/keyrings/zabbly.gpg
          sudo sh -c "cat > /etc/apt/sources.list.d/zabbly-incus-stable.sources" <<EOF
          Enabled: yes
          Types: deb
          URIs: https://pkgs.zabbly.com/incus/stable
          Suites: $(. /etc/os-release && echo ${VERSION_CODENAME})
          Components: main
          Architectures: $(dpkg --print-architecture)
          Signed-By: /usr/share/keyrings/zabbly.gpg
          EOF
          sudo apt-get update
          sudo apt-get install -y incus

      # 2. 初始化 Incus
      - name: Initialize Incus
        run: |
          echo "Initializing Incus..."
          sudo incus admin init --auto

      # 3. 配置 rclone
      - name: Configure rclone for WebDAV
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
          [${WEBDAV_REMOTE}]
          type = webdav
          url  = ${{ secrets.WEBDAV_URL }}
          vendor = other
          user = ${{ secrets.WEBDAV_USER }}
          pass = $(echo '${{ secrets.WEBDAV_PASS }}' | rclone obscure -)
          EOF

      # 4. 检查并恢复/创建容器（macvlan Host Networking）
      - name: Check, Restore or Create Container with Host Networking
        run: |
          if [ -n "$(rclone lsf ${WEBDAV_REMOTE}:/ --include ${BACKUP_FILE})" ]; then
            echo "Backup found. Downloading and restoring..."
            rclone copy ${WEBDAV_REMOTE}:${BACKUP_FILE} .
            sudo incus import ${BACKUP_FILE} ${CONTAINER_NAME}

            echo "Configuring macvlan host network on restored container..."
            sudo incus config device add ${CONTAINER_NAME} eth0 nic \
              nictype=macvlan parent=eth0

            sudo incus start ${CONTAINER_NAME}
          else
            echo "No backup found. Launching new container..."
            sudo incus launch images:ubuntu/22.04 ${CONTAINER_NAME}

            echo "Adding macvlan host network..."
            sudo incus config device add ${CONTAINER_NAME} eth0 nic \
              nictype=macvlan parent=eth0
          fi

          echo "Waiting for container to be ready..."
          sleep 5

          echo "Verifying container internet access..."
          sudo incus exec ${CONTAINER_NAME} -- apt-get update

      # 5. 启用 Upterm 调试会话（SSH）
      - name: Enable Upterm debugging
        uses: lhotari/action-upterm@v1
        with:
          limit-access-to-actor: true
          wait-timeout-minutes: 348

      # 6. 停止并备份容器
      - name: Stop and Backup Container
        run: |
          echo "Stopping container..."
          sudo incus stop ${CONTAINER_NAME} --force
          echo "Exporting container..."
          sudo incus export ${CONTAINER_NAME} ${BACKUP_FILE} --force
          echo "Uploading new backup to WebDAV..."
          rclone copyto ${BACKUP_FILE} ${WEBDAV_REMOTE}:${BACKUP_FILE}
          echo "Backup complete."