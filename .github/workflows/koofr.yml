name: Koofr WebDAV Speed Test

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘æµ‹è¯•

jobs:
  speed-test:
    runs-on: ubuntu-latest
    env:
      TEST_FILE: "test1gb.bin"  # æµ‹è¯•æ–‡ä»¶å
      RCLONE_CONFIG: /tmp/rclone.conf  # rclone é…ç½®æ–‡ä»¶è·¯å¾„

    steps:
    - name: å®‰è£… rclone âš™ï¸
      run: |
        curl https://rclone.org/install.sh | sudo bash
        rclone version

    - name: é…ç½® rclone ğŸ”‘
      run: |
        # æ³¨æ„ï¼šè¿™é‡Œä¸å†åŒ…å« "pass" å­—æ®µ
        cat > $RCLONE_CONFIG <<EOF
        [koofr]
        type = webdav
        url = https://app.koofr.net/dav/Koofr/
        vendor = other
        user = ${{ secrets.WEBDAVK_USER }}

        [gdrive]
        type = webdav
        url = https://app.koofr.net/dav/GDrive/
        vendor = other
        user = ${{ secrets.WEBDAVK_USER }}
        EOF
        
        chmod 600 $RCLONE_CONFIG
        echo "Rclone é…ç½®å®Œæˆï¼"
        # ä¸ºäº†éªŒè¯ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦æä¾›å¯†ç æ¥åˆ—å‡ºè¿œç¨‹
        echo "åˆ—å‡ºè¿œç¨‹ (éœ€è¦å¯†ç ):"
        RCLONE_CONFIG_KOOFR_PASS=${{ secrets.WEBDAVK_PASS }} RCLONE_CONFIG_GDRIVE_PASS=${{ secrets.WEBDAVK_PASS }} rclone listremotes --config $RCLONE_CONFIG

    - name: ç”Ÿæˆ 1GB æµ‹è¯•æ–‡ä»¶ âš™ï¸
      run: |
        dd if=/dev/urandom of=$TEST_FILE bs=1M count=1024
        ls -lh $TEST_FILE

    - name: æµ‹è¯• Koofr ç›®å½• â¬†ï¸â¬‡ï¸
      id: test_koofr
      # é€šè¿‡ env å°†å¯†ç ä½œä¸ºç¯å¢ƒå˜é‡ä¼ é€’ç»™ rclone
      env:
        RCLONE_CONFIG_KOOFR_PASS: ${{ secrets.WEBDAVK_PASS }}
      run: |
        # ä¸Šä¼ æµ‹è¯•
        echo "ğŸ”„ å¼€å§‹ä¸Šä¼ åˆ° Koofr ç›®å½•..."
        start_time=$(date +%s.%N)
        rclone copy $TEST_FILE koofr: --config $RCLONE_CONFIG -v
        end_time=$(date +%s.%N)
        
        upload_time=$(echo "$end_time - $start_time" | bc)
        upload_speed=$(echo "scale=2; 1024 / $upload_time" | bc)
        echo "ğŸ“¤ Koofr ä¸Šä¼ é€Ÿåº¦: $upload_speed MB/s"
        echo "koofr_upload_speed=$upload_speed" >> $GITHUB_OUTPUT
        
        # ä¸‹è½½æµ‹è¯•
        echo "ğŸ”„ å¼€å§‹ä» Koofr ç›®å½•ä¸‹è½½..."
        start_time=$(date +%s.%N)
        rclone copy koofr:$TEST_FILE ./downloaded_koofr.bin --config $RCLONE_CONFIG -v
        end_time=$(date +%s.%N)
        
        download_time=$(echo "$end_time - $start_time" | bc)
        download_speed=$(echo "scale=2; 1024 / $download_time" | bc)
        echo "ğŸ“¥ Koofr ä¸‹è½½é€Ÿåº¦: $download_speed MB/s"
        echo "koofr_download_speed=$download_speed" >> $GITHUB_OUTPUT
        
        # æ¸…ç†
        rclone delete koofr:$TEST_FILE --config $RCLONE_CONFIG -v
        rm -f downloaded_koofr.bin

    - name: æµ‹è¯• GDrive ç›®å½• â¬†ï¸â¬‡ï¸
      id: test_gdrive
      # é€šè¿‡ env å°†å¯†ç ä½œä¸ºç¯å¢ƒå˜é‡ä¼ é€’ç»™ rclone
      env:
        RCLONE_CONFIG_GDRIVE_PASS: ${{ secrets.WEBDAVK_PASS }}
      run: |
        # ä¸Šä¼ æµ‹è¯•
        echo "ğŸ”„ å¼€å§‹ä¸Šä¼ åˆ° GDrive ç›®å½•..."
        start_time=$(date +%s.%N)
        rclone copy $TEST_FILE gdrive: --config $RCLONE_CONFIG -v
        end_time=$(date +%s.%N)
        
        upload_time=$(echo "$end_time - $start_time" | bc)
        upload_speed=$(echo "scale=2; 1024 / $upload_time" | bc)
        echo "ğŸ“¤ GDrive ä¸Šä¼ é€Ÿåº¦: $upload_speed MB/s"
        echo "gdrive_upload_speed=$upload_speed" >> $GITHUB_OUTPUT
        
        # ä¸‹è½½æµ‹è¯•
        echo "ğŸ”„ å¼€å§‹ä» GDrive ç›®å½•ä¸‹è½½..."
        start_time=$(date +%s.%N)
        rclone copy gdrive:$TEST_FILE ./downloaded_gdrive.bin --config $RCLONE_CONFIG -v
        end_time=$(date +%s.%N)
        
        download_time=$(echo "$end_time - $start_time" | bc)
        download_speed=$(echo "scale=2; 1024 / $download_time" | bc)
        echo "ğŸ“¥ GDrive ä¸‹è½½é€Ÿåº¦: $download_speed MB/s"
        echo "gdrive_download_speed=$download_speed" >> $GITHUB_OUTPUT
        
        # æ¸…ç†
        rclone delete gdrive:$TEST_FILE --config $RCLONE_CONFIG -v
        rm -f downloaded_gdrive.bin

    - name: æ¸…ç†æµ‹è¯•æ–‡ä»¶ ğŸ§¹
      run: |
        rm -f $TEST_FILE

    - name: æ˜¾ç¤ºæµ‹è¯•ç»“æœ ğŸ“Š
      run: |
        echo "--------------------------------"
        echo "ğŸ”¥ Koofr WebDAV æµ‹é€Ÿç»“æœ"
        echo "--------------------------------"
        echo "ğŸ“‚ Koofr ç›®å½• (https://app.koofr.net/dav/Koofr/)"
        echo "ğŸ“¤ ä¸Šä¼ é€Ÿåº¦: ${{ steps.test_koofr.outputs.koofr_upload_speed }} MB/s"
        echo "ğŸ“¥ ä¸‹è½½é€Ÿåº¦: ${{ steps.test_koofr.outputs.koofr_download_speed }} MB/s"
        echo ""
        echo "ğŸ“‚ GDrive ç›®å½• (https://app.koofr.net/dav/GDrive/)"
        echo "ğŸ“¤ ä¸Šä¼ é€Ÿåº¦: ${{ steps.test_gdrive.outputs.gdrive_upload_speed }} MB/s"
        echo "ğŸ“¥ ä¸‹è½½é€Ÿåº¦: ${{ steps.test_gdrive.outputs.gdrive_download_speed }} MB/s"
        echo "--------------------------------"