# å·¥ä½œæµåç§°
name: 'Migration: Sync WebDAV to B2'

# å·¥ä½œæµè§¦å‘å™¨
on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'ğŸ§ª æ˜¯å¦å¯ç”¨æ¼”ç»ƒæ¨¡å¼ (Dry Run)? (åªä¼šæ˜¾ç¤ºå°†è¦ä¼ è¾“çš„æ–‡ä»¶ï¼Œä¸ä¼šå®é™…æ“ä½œ)'
        required: true
        type: boolean
        default: true

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  # Rclone è¿œç¨‹çš„å†…éƒ¨åç§° (å¯è‡ªå®šä¹‰)
  WEBDAV_REMOTE_NAME: "webdav_source"
  B2_REMOTE_NAME: "b2_destination"

  # å¤‡ä»½æ–‡ä»¶æ‰€åœ¨çš„ç›®å½• (å‡è®¾ä¸¤è¾¹éƒ½å« 'backup')
  REMOTE_PATH: "backup"

  # WebDAV Secrets
  WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
  WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
  WEBDAV_PASS: ${{ secrets.WEBDAV_PASS }}

  # B2 Secrets
  B2_KEY_ID: ${{ secrets.B2_KEY_ID }}
  B2_APPLICATION_KEY: ${{ secrets.B2_APPLICATION_KEY }}
  B2_BUCKET_NAME: ${{ secrets.B2_BUCKET_NAME }}
  
  # Rclone é€šç”¨ä¼ è¾“å‚æ•°
  RCLONE_FLAGS: "--multi-thread-streams 8 --buffer-size 64M --fast-list --transfers 16 --progress"

jobs:
  migrate-data:
    name: "Sync Data from WebDAV to B2"
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. å®‰è£… Rclone
        run: sudo apt-get update && sudo apt-get install -y rclone

      - name: 2. é…ç½® Rclone Remotes (WebDAV å’Œ B2)
        run: |
          echo "--- å¼€å§‹é…ç½® Rclone ---"
          
          # é…ç½® WebDAV æº
          echo "1. é…ç½® WebDAV æº: ${{ env.WEBDAV_REMOTE_NAME }}"
          rclone config create ${{ env.WEBDAV_REMOTE_NAME }} webdav \
            url "${{ env.WEBDAV_URL }}" \
            vendor "other" \
            user "${{ env.WEBDAV_USER }}" \
            pass "${{ env.WEBDAV_PASS }}"

          # é…ç½® B2 ç›®æ ‡
          echo "2. é…ç½® B2 ç›®æ ‡: ${{ env.B2_REMOTE_NAME }}"
          rclone config create ${{ env.B2_REMOTE_NAME }} b2 \
            account "${{ env.B2_KEY_ID }}" \
            key "${{ env.B2_APPLICATION_KEY }}"

          echo "âœ… Rclone é…ç½®å®Œæˆã€‚å·²è®¾ç½®ä¸¤ä¸ªè¿œç¨‹ã€‚"
          rclone listremotes

      - name: 3. æ‰§è¡Œæ•°æ®åŒæ­¥
        run: |
          SOURCE="${{ env.WEBDAV_REMOTE_NAME }}:${{ env.REMOTE_PATH }}"
          DESTINATION="${{ env.B2_REMOTE_NAME }}:${{ env.B2_BUCKET_NAME }}/${{ env.REMOTE_PATH }}"
          
          echo "åŒæ­¥æº: ${SOURCE}"
          echo "åŒæ­¥ç›®æ ‡: ${DESTINATION}"
          
          # æ ¹æ®è¾“å…¥å‚æ•°å†³å®šæ˜¯å¦ä¸ºæ¼”ç»ƒæ¨¡å¼
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "--- ğŸ§ª æ¼”ç»ƒæ¨¡å¼ (DRY RUN) ---"
            echo "ä»¥ä¸‹æ–‡ä»¶å°†ä¼šè¢«åŒæ­¥ï¼Œä½†ä¸ä¼šæ‰§è¡Œå®é™…æ“ä½œï¼š"
            rclone sync "${SOURCE}" "${DESTINATION}" --dry-run ${{ env.RCLONE_FLAGS }}
          else
            echo "--- ğŸš€ å®æ—¶åŒæ­¥æ¨¡å¼ (LIVE RUN) ---"
            echo "è­¦å‘Šï¼šç°åœ¨å°†å¼€å§‹å®é™…çš„æ–‡ä»¶ä¼ è¾“ï¼"
            rclone sync "${SOURCE}" "${DESTINATION}" ${{ env.RCLONE_FLAGS }}
            echo "âœ… åŒæ­¥æ“ä½œæ‰§è¡Œå®Œæ¯•ã€‚"
          fi

      - name: 4. [å¯é€‰] éªŒè¯åŒæ­¥ç»“æœ
        if: github.event.inputs.dry_run == 'false' # ä»…åœ¨çœŸå®åŒæ­¥åæ‰éªŒè¯
        run: |
          echo "--- å¼€å§‹éªŒè¯åŒæ­¥ç»“æœ ---"
          SOURCE="${{ env.WEBDAV_REMOTE_NAME }}:${{ env.REMOTE_PATH }}"
          DESTINATION="${{ env.B2_REMOTE_NAME }}:${{ env.B2_BUCKET_NAME }}/${{ env.REMOTE_PATH }}"
          
          # rclone check ä¼šæ¯”è¾ƒæºå’Œç›®æ ‡çš„æ–‡ä»¶ï¼Œå¦‚æœä¸€è‡´åˆ™æˆåŠŸé€€å‡º
          rclone check "${SOURCE}" "${DESTINATION}" --one-way --progress
          echo "âœ… éªŒè¯å®Œæˆï¼Œä¸¤è¾¹æ–‡ä»¶ä¸€è‡´ï¼"