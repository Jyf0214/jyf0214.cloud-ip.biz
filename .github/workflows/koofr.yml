# GitHub Action Workflow to run MAA-CLI (Version 3 with namespaced variables)
name: MAA Runner

on:
  workflow_dispatch:
    inputs:
      # 输入参数也已更新
      maa_command_2:
        description: 'The MAA command to run (e.g., "roguelike Mizuki")'
        required: true
        default: 'roguelike Mizuki'

jobs:
  run-maa:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      - name: 2. Install Dependencies (Rust, Rclone)
        run: |
          sudo apt-get update
          sudo apt-get install -y rustc cargo rclone

      - name: 3. Compile MAA-CLI from Source
        run: |
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          cargo install --git https://github.com/MaaAssistantArknights/maa-cli.git --bin maa --tag stable --locked

      - name: 4. Configure Rclone for Backblaze B2
        run: |
          mkdir -p ~/.config/rclone
          # 所有 secrets 变量名已更新
          echo "[b2]
          type = b2
          account = ${{ secrets.B2_KEY_ID_2 }}
          key = ${{ secrets.B2_APPLICATION_KEY_2 }}
          download_url = ${{ secrets.B2_DOWNLOAD_URL_2 }}" > ~/.config/rclone/rclone.conf

      - name: 5. Download MAA Configs from B2
        run: |
          mkdir -p ~/.config/maa-cli
          # B2_BUCKET_NAME_2 已更新
          rclone sync b2:${{ secrets.B2_BUCKET_NAME_2 }}/maa-configs ~/.config/maa-cli || true

      - name: 6. Install MAA Core and Resources
        env:
          # B2_DOWNLOAD_URL_2 已更新
          B2_DOWNLOAD_URL: ${{ secrets.B2_DOWNLOAD_URL_2 }}
        run: maa install

      - name: 7. Run the MAA Task
        # 输入参数变量名已更新
        run: maa ${{ github.event.inputs.maa_command_2 }}

      - name: 8. Upload Logs and Results back to B2
        if: always()
        run: |
          # 本地变量也已更新
          LOG_DIR_2=$(maa dir log)
          echo "MAA config directory is: ~/.config/maa-cli"
          echo "MAA log directory is: $LOG_DIR_2"
          
          echo "Syncing configs back to B2..."
          # B2_BUCKET_NAME_2 已更新
          rclone sync ~/.config/maa-cli b2:${{ secrets.B2_BUCKET_NAME_2 }}/maa-configs
          
          echo "Syncing logs to B2..."
          # B2_BUCKET_NAME_2 和本地变量已更新
          rclone sync "$LOG_DIR_2" b2:${{ secrets.B2_BUCKET_NAME_2 }}/maa-logs