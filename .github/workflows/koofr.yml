name: Koofr WebDAV Speed Test

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘æµ‹è¯•

jobs:
  speed-test:
    runs-on: ubuntu-latest
    env:
      TEST_FILE: "test1gb.bin"
      RCLONE_CONFIG: /tmp/rclone.conf
      # æˆ‘ä»¬å°†å¯†ç ä½œä¸ºç¯å¢ƒå˜é‡ï¼Œç”¨äºç”Ÿæˆé…ç½®æ–‡ä»¶
      WEBDAV_USER: ${{ secrets.WEBDAVK_USER }}
      WEBDAV_PASS: ${{ secrets.WEBDAVK_PASS }}

    steps:
    - name: å®‰è£… rclone âš™ï¸
      run: |
        curl https://rclone.org/install.sh | sudo bash
        rclone version

    - name: é…ç½® rclone ğŸ”‘ (ä½¿ç”¨ rclone obscure)
      run: |
        # ä½¿ç”¨ rclone obscure å‘½ä»¤ä¸ºæˆ‘ä»¬çš„å¯†ç ç”ŸæˆåŠ å¯†å­—ç¬¦ä¸²
        OBSCURED_PASS=$(echo -n "$WEBDAV_PASS" | rclone obscure -)

        # åˆ›å»ºä¸€ä¸ªå®Œå…¨ç¬¦åˆ rclone è§„èŒƒçš„é…ç½®æ–‡ä»¶
        # æ³¨æ„ 'pass' å­—æ®µç°åœ¨å°†åŒ…å«åŠ å¯†åçš„å¯†ç 
        cat > $RCLONE_CONFIG <<EOF
        [koofr]
        type = webdav
        url = https://app.koofr.net/dav/Koofr/
        vendor = other
        user = $WEBDAV_USER
        pass = $OBSCURED_PASS

        [gdrive]
        type = webdav
        url = https://app.koofr.net/dav/GDrive/
        vendor = other
        user = $WEBDAV_USER
        pass = $OBSCURED_PASS
        EOF
        
        chmod 600 $RCLONE_CONFIG
        echo "Rclone é…ç½®å®Œæˆï¼"
        
        # ç°åœ¨ rclone å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œæ— éœ€ä»»ä½•é¢å¤–çš„ç¯å¢ƒå˜é‡
        echo "éªŒè¯è¿œç¨‹åˆ—è¡¨:"
        rclone listremotes --config $RCLONE_CONFIG

    - name: ç”Ÿæˆ 1GB æµ‹è¯•æ–‡ä»¶ âš™ï¸
      run: |
        dd if=/dev/urandom of=$TEST_FILE bs=1M count=1024
        ls -lh $TEST_FILE

    - name: æµ‹è¯• Koofr ç›®å½• â¬†ï¸â¬‡ï¸
      id: test_koofr
      run: |
        # ä¸Šä¼ æµ‹è¯•
        echo "ğŸ”„ å¼€å§‹ä¸Šä¼ åˆ° Koofr ç›®å½•..."
        start_time=$(date +%s.%N)
        rclone copy $TEST_FILE koofr: --config $RCLONE_CONFIG -v
        end_time=$(date +%s.%N)
        
        upload_time=$(echo "$end_time - $start_time" | bc)
        upload_speed=$(echo "scale=2; 1024 / $upload_time" | bc)
        echo "ğŸ“¤ Koofr ä¸Šä¼ é€Ÿåº¦: $upload_speed MB/s"
        echo "koofr_upload_speed=$upload_speed" >> $GITHUB_OUTPUT
        
        # ä¸‹è½½æµ‹è¯•
        echo "ğŸ”„ å¼€å§‹ä» Koofr ç›®å½•ä¸‹è½½..."
        start_time=$(date +%s.%N)
        rclone copy koofr:$TEST_FILE ./downloaded_koofr.bin --config $RCLONE_CONFIG -v
        end_time=$(date +%s.%N)
        
        download_time=$(echo "$end_time - $start_time" | bc)
        download_speed=$(echo "scale=2; 1024 / $download_time" | bc)
        echo "ğŸ“¥ Koofr ä¸‹è½½é€Ÿåº¦: $download_speed MB/s"
        echo "koofr_download_speed=$download_speed" >> $GITHUB_OUTPUT
        
        # æ¸…ç†
        rclone delete koofr:$TEST_FILE --config $RCLONE_CONFIG -v
        rm -f downloaded_koofr.bin

    - name: æµ‹è¯• GDrive ç›®å½• â¬†ï¸â¬‡ï¸
      id: test_gdrive
      run: |
        # ä¸Šä¼ æµ‹è¯•
        echo "ğŸ”„ å¼€å§‹ä¸Šä¼ åˆ° GDrive ç›®å½•..."
        start_time=$(date +%s.%N)
        rclone copy $TEST_FILE gdrive: --config $RCLONE_CONFIG -v
        end_time=$(date +%s.%N)
        
        upload_time=$(echo "$end_time - $start_time" | bc)
        upload_speed=$(echo "scale=2; 1024 / $upload_time" | bc)
        echo "ğŸ“¤ GDrive ä¸Šä¼ é€Ÿåº¦: $upload_speed MB/s"
        echo "gdrive_upload_speed=$upload_speed" >> $GITHUB_OUTPUT
        
        # ä¸‹è½½æµ‹è¯•
        echo "ğŸ”„ å¼€å§‹ä» GDrive ç›®å½•ä¸‹è½½..."
        start_time=$(date +%s.%N)
        rclone copy gdrive:$TEST_FILE ./downloaded_gdrive.bin --config $RCLONE_CONFIG -v
        end_time=$(date +%s.%N)
        
        download_time=$(echo "$end_time - $start_time" | bc)
        download_speed=$(echo "scale=2; 1024 / $download_time" | bc)
        echo "ğŸ“¥ GDrive ä¸‹è½½é€Ÿåº¦: $download_speed MB/s"
        echo "gdrive_download_speed=$download_speed" >> $GITHUB_OUTPUT
        
        # æ¸…ç†
        rclone delete gdrive:$TEST_FILE --config $RCLONE_CONFIG -v
        rm -f downloaded_gdrive.bin

    - name: æ¸…ç†æµ‹è¯•æ–‡ä»¶ ğŸ§¹
      run: |
        rm -f $TEST_FILE

    - name: æ˜¾ç¤ºæµ‹è¯•ç»“æœ ğŸ“Š
      run: |
        echo "--------------------------------"
        echo "ğŸ”¥ Koofr WebDAV æµ‹é€Ÿç»“æœ"
        echo "--------------------------------"
        echo "ğŸ“‚ Koofr ç›®å½• (https://app.koofr.net/dav/Koofr/)"
        echo "ğŸ“¤ ä¸Šä¼ é€Ÿåº¦: ${{ steps.test_koofr.outputs.koofr_upload_speed }} MB/s"
        echo "ğŸ“¥ ä¸‹è½½é€Ÿåº¦: ${{ steps.test_koofr.outputs.koofr_download_speed }} MB/s"
        echo ""
        echo "ğŸ“‚ GDrive ç›®å½• (https://app.koofr.net/dav/GDrive/)"
        echo "ğŸ“¤ ä¸Šä¼ é€Ÿåº¦: ${{ steps.test_gdrive.outputs.gdrive_upload_speed }} MB/s"
        echo "ğŸ“¥ ä¸‹è½½é€Ÿåº¦: ${{ steps.test_gdrive.outputs.gdrive_download_speed }} MB/s"
        echo "--------------------------------"