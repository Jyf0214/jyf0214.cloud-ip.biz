# å·¥ä½œæµåç§°
name: CI with Persistent Environment (Backblaze B2 Backups - v8 Secure)

# å·¥ä½œæµè§¦å‘å™¨
on:
  workflow_dispatch:
    inputs:
      # --- æ ¸å¿ƒè°ƒè¯•ä¸æ¨¡å¼å¼€å…³ ---
      no_cache:
        description: 'ğŸš« [æ¨¡å¼] ä¸æ¢å¤å¤‡ä»½,å¼ºåˆ¶åˆ›å»ºå…¨æ–°ç¯å¢ƒ? (æœåŠ¡ä¸ä¼šè‡ªåŠ¨å¯åŠ¨,å°†å¼ºåˆ¶SSH,ä½†ç»“æŸæ—¶ä»ä¼šå¤‡ä»½)'
        required: true
        type: boolean
        default: false
      enable_ssh:
        description: 'ğŸ [è°ƒè¯•] æ­£å¸¸æ¨¡å¼ä¸‹, æ˜¯å¦å¯ç”¨SSHæ‰‹åŠ¨è°ƒè¯• (å°†æš‚åœè‡ªåŠ¨åŒ–)?'
        required: true
        type: boolean
        default: false

      # --- æ ¸å¿ƒåŠŸèƒ½å¼€å…³ (no_cache=false æ—¶æœ‰æ•ˆ) ---
      create_backup_on_finish:
        description: 'âœ… [æ ¸å¿ƒ] æ˜¯å¦åœ¨ç»“æŸæ—¶åˆ›å»ºç¯å¢ƒå¤‡ä»½? (æ— è®ºæ˜¯å¦ä½¿ç”¨æ— ç¼“å­˜æ¨¡å¼,æ­¤å¼€å…³éƒ½æœ‰æ•ˆ)'
        required: true
        type: boolean
        default: true
      run_startup_script:
        description: 'ğŸš€ [æ ¸å¿ƒ] æ˜¯å¦è‡ªåŠ¨æ‰§è¡ŒChrootå†…çš„æœåŠ¡å¯åŠ¨è„šæœ¬? (æ— ç¼“å­˜æ¨¡å¼ä¸‹æ— æ•ˆ)'
        required: true
        type: boolean
        default: true
      
      # --- æœåŠ¡å¯åŠ¨æ§åˆ¶ (run_startup_script=true æ—¶æœ‰æ•ˆ) ---
      services_to_run:
        description: '  - è¦å¯åŠ¨çš„æœåŠ¡åˆ—è¡¨ (é€—å·åˆ†éš”, å¦‚: launcher,redis,yunzai). ç•™ç©ºæˆ–å¡« "all" å¯åŠ¨æ‰€æœ‰é»˜è®¤æœåŠ¡.'
        type: string
        default: 'launcher,redis,yunzai,loophole_webdav,openlist,chmlfrp'

# å¹¶å‘æ§åˆ¶
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

# ========================================================================================
# --- å…¨å±€ç¯å¢ƒå˜é‡ (é›†ä¸­ç®¡ç†æ‰€æœ‰é…ç½®å’Œå¯†é’¥) ---
# ========================================================================================
env:
  # --- åŸºç¡€è·¯å¾„å’Œé…ç½® ---
  CHROOT_DIR: /mnt/minisys
  PYTHON_APP_REPO_DIR: chatgpt-on-wechat
  NODE_VERSION: '18'

  # --- Backblaze B2 å¤‡ä»½é…ç½® ---
  B2_REMOTE_NAME: b2
  BACKUP_PREFIX: minisys_backup_
  B2_BACKUP_DIR: backup
  BACKUP_RETENTION_COUNT: 3
  RCLONE_FLAGS: "--multi-thread-streams 4 --buffer-size 64M --fast-list --transfers 8 --progress"

  # --- GitHub & App Secrets ---
  B2_ACCOUNT_ID: ${{ secrets.B2_ACCOUNT_ID }}
  B2_ACCOUNT_KEY: ${{ secrets.B2_ACCOUNT_KEY }}
  B2_BUCKET_NAME: ${{ secrets.B2_BUCKET_NAME }}
  B2_DOWNLOAD_URL: ${{ secrets.B2_DOWNLOAD_URL }} # æ³¨æ„: æ­¤å˜é‡ä¸å†è¢«echo, ä»…ä¾›å†…éƒ¨æ½œåœ¨ä½¿ç”¨
  PAT: ${{ secrets.YUNZAIBOT_PAT }}

  # --- Chroot å†…æœåŠ¡æ‰€éœ€ Secrets ---
  LOOPHOLE_WEBDAV_USER: ${{ secrets.LOOPHOLE_WEBDAV_USER }}
  LOOPHOLE_WEBDAV_PASS: ${{ secrets.LOOPHOLE_WEBDAV_PASS }}
  LOOPHOLE_WEBDAV_HOSTNAME: ${{ secrets.LOOPHOLE_WEBDAV_HOSTNAME }}
  LOOPHOLE_NAPCAT_HOSTNAME: ${{ secrets.LOOPHOLE_NAPCAT_HOSTNAME }}
  NAPCATUSER: ${{ secrets.NAPCATUSER }}
  NAPCATPASS: ${{ secrets.NAPCATPASS }}

jobs:
  build-and-run-all:
    name: "Run All Services (B2 Enhanced v8)"
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: 2. æœ€å¤§åŒ–è¿è¡Œå™¨ç£ç›˜ç©ºé—´
        run: sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY"

      - name: 3. å®‰è£…å…¨éƒ¨æ‰€éœ€ä¾èµ–
        run: sudo apt-get update && sudo apt-get install -y debootstrap rclone pigz zstd jq

      - name: 4. è®¾ç½®è¿è¡Œå™¨çš„ Node.js å’Œ Python ç¯å¢ƒ
        uses: actions/setup-node@v3
        with: { node-version: '${{ env.NODE_VERSION }}' }
      - uses: actions/setup-python@v4
        with: { python-version: "3.9" }

      - name: 5A. [ç¼“å­˜æ¨¡å¼] âš¡ï¸ å¹¶è¡Œæ‰§è¡Œï¼šæ™ºèƒ½æ¢å¤ Chroot & éƒ¨ç½²åº”ç”¨
        if: github.event.inputs.no_cache == 'false'
        id: restore_or_create
        run: |
          # æ­¤æ­¥éª¤çš„è„šæœ¬ä¸ v7 ç‰ˆæœ¬ç›¸åŒï¼Œå¹¶è¡Œæ¢å¤å’Œéƒ¨ç½²
          BG_LOG_FILE=$(mktemp)
          echo "ğŸ“„ åå°ä»»åŠ¡æ—¥å¿—å°†è®°å½•åœ¨: ${BG_LOG_FILE}"

          # å¯åŠ¨åå°ä»»åŠ¡ï¼šæ™ºèƒ½æ¢å¤æˆ–åˆ›å»º Chroot ç¯å¢ƒ
          (
            set -eo pipefail
            echo "--- [åå°ä»»åŠ¡] å¼€å§‹æ‰§è¡Œ Chroot æ™ºèƒ½æ¢å¤/åˆ›å»º ---"
            sudo mkdir -p ${{ env.CHROOT_DIR }}
            rclone config create ${{ env.B2_REMOTE_NAME }} b2 account "${B2_ACCOUNT_ID}" key "${B2_ACCOUNT_KEY}"

            echo "1. æ­£åœ¨ä» Backblaze B2 (${B2_BUCKET_NAME}) çš„æ ¹ç›®å½•æŸ¥æ‰¾æœ€æ–°çš„å¤‡ä»½..."
            LATEST_BACKUP_FILENAME=$(rclone lsjson ${{ env.B2_REMOTE_NAME }}:${B2_BUCKET_NAME}/ | \
                                      jq -r '[.[] | select(.Name | test("${{ env.BACKUP_PREFIX }}.*\\.tar\\.(zst|gz)$"))] | sort_by(.ModTime) | .[-1].Name' 2>/dev/null)

            if [[ -n "$LATEST_BACKUP_FILENAME" && "$LATEST_BACKUP_FILENAME" != "null" ]]; then
                echo "   -> âœ… å‘ç°æœ€æ–°å¯ç”¨å¤‡ä»½: ${LATEST_BACKUP_FILENAME}"
                LOCAL_BACKUP_PATH="/tmp/backup.archive"
                rclone copyto "${{ env.B2_REMOTE_NAME }}:${B2_BUCKET_NAME}/${LATEST_BACKUP_FILENAME}" ${LOCAL_BACKUP_PATH} ${{ env.RCLONE_FLAGS }}
                echo "--- [åå°ä»»åŠ¡] âœ… ä¸‹è½½å®Œæˆã€‚å¼€å§‹è§£å‹..."
                
                if [[ "${LATEST_BACKUP_FILENAME}" == *.zst ]]; then
                    unzstd -c ${LOCAL_BACKUP_PATH} | sudo tar -xpf - -C ${{ env.CHROOT_DIR }}
                else
                    pigz -dc ${LOCAL_BACKUP_PATH} | sudo tar -xpf - -C ${{ env.CHROOT_DIR }}
                fi
                rm -f ${LOCAL_BACKUP_PATH}
            else
              echo "--- [åå°ä»»åŠ¡] âš ï¸ æ‰€æœ‰ç±»å‹çš„å¤‡ä»½å‡æœªæ‰¾åˆ°ã€‚å°†åˆ›å»ºå…¨æ–°ç³»ç»Ÿ..."
              sudo debootstrap --variant=minbase jammy ${{ env.CHROOT_DIR }} http://archive.ubuntu.com/ubuntu/
            fi
            echo "--- [åå°ä»»åŠ¡] âœ… Chroot æ¢å¤/åˆ›å»ºä»»åŠ¡æˆåŠŸå®Œæˆ ---"
          ) > ${BG_LOG_FILE} 2>&1 &
          CHROOT_SETUP_PID=$!
          
          # å‰å°ä»»åŠ¡ï¼šéƒ¨ç½² Python åº”ç”¨
          echo "--- [å‰å°ä»»åŠ¡] åå°æ­£åœ¨æ¢å¤ Chrootï¼Œå‰å°å¼€å§‹éƒ¨ç½² Python åº”ç”¨... ---"
          npm install -g pm2; rm -rf ${{ env.PYTHON_APP_REPO_DIR }}
          git clone https://x-access-token:${{ env.PAT }}@github.com/Jyf0214/${{ env.PYTHON_APP_REPO_DIR }}.git || true
          cd ${{ env.PYTHON_APP_REPO_DIR }} && python -m pip install --upgrade pip && pip install -r requirements.txt --target ./ || true && pm2 start "python3 app.py" --name "python-app"
          
          echo "--- [å‰å°ä»»åŠ¡] âœ… Python åº”ç”¨å·²å¯åŠ¨ã€‚ç­‰å¾…åå° Chroot ä»»åŠ¡å®Œæˆ... ---"
          if ! wait ${CHROOT_SETUP_PID}; then
            echo "=================================================" >&2; echo "âŒ ERROR: åå° Chroot è®¾ç½®ä»»åŠ¡å¤±è´¥ï¼" >&2; cat ${BG_LOG_FILE} >&2; exit 1
          fi
          
          echo "--- âœ… æ‰€æœ‰å¹¶è¡Œä»»åŠ¡å®Œæˆ ---"
          if [[ -f "${{ env.CHROOT_DIR }}/etc/debian_version" ]]; then echo "restored=true" >> $GITHUB_OUTPUT; else echo "restored=false" >> $GITHUB_OUTPUT; fi
      
      - name: 5B. [æ— ç¼“å­˜æ¨¡å¼] åˆ›å»ºå…¨æ–°çš„ Chroot ç¯å¢ƒ
        if: github.event.inputs.no_cache == 'true'
        run: |
          echo "ğŸš« æ£€æµ‹åˆ°æ— ç¼“å­˜æ¨¡å¼, å°†åˆ›å»ºå…¨æ–°çš„ Chroot ç¯å¢ƒ..."
          sudo mkdir -p ${{ env.CHROOT_DIR }}
          sudo debootstrap --variant=minbase jammy ${{ env.CHROOT_DIR }} http://archive.ubuntu.com/ubuntu/
          echo "âœ… å…¨æ–° Chroot ç¯å¢ƒåˆ›å»ºå®Œæˆã€‚"

      - name: 6. æŒ‚è½½è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
        run: |
          MNT_DIR=${{ env.CHROOT_DIR }}
          sudo mount -t proc proc "${MNT_DIR}/proc"; sudo mount -o bind /dev "${MNT_DIR}/dev"; sudo mount -o bind /dev/pts "${MNT_DIR}/dev/pts"; sudo mount -o bind /sys "${MNT_DIR}/sys"

      - name: 7A. [ç¼“å­˜æ¨¡å¼] æ¸…ç† Chroot ç¯å¢ƒç©ºé—´
        if: steps.restore_or_create.outputs.restored == 'true' && github.event.inputs.no_cache == 'false'
        run: |
          # ä»…åœ¨æ¢å¤äº†å¤‡ä»½æ—¶æ‰§è¡Œæ¸…ç†
          sudo chroot ${{ env.CHROOT_DIR }} /bin/bash -c "set -x; apt-get clean -y; apt-get autoremove -y; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*; find /var/log -type f -delete"

      - name: 7B. [ä¿®å¤] å®‰è£… Chroot ç¯å¢ƒå†…çš„ Node.js å’Œ PM2
        # åœ¨è‡ªåŠ¨åŒ–æˆ–æ— ç¼“å­˜è°ƒè¯•æ¨¡å¼ä¸‹ï¼Œéƒ½éœ€è¦ç¡®ä¿chrootå†…æœ‰Node.jsç¯å¢ƒ
        if: (github.event.inputs.run_startup_script == 'true' && github.event.inputs.no_cache == 'false') || github.event.inputs.no_cache == 'true'
        run: |
          echo "--- [Chroot Prep] å¼€å§‹åœ¨ Chroot ç¯å¢ƒä¸­å®‰è£… Node.js å’Œ PM2 ---"
          sudo tee ${{ env.CHROOT_DIR }}/tmp/prepare_env.sh > /dev/null << EOF
          #!/bin/bash
          set -ex
          echo "nameserver 8.8.8.8" > /etc/resolv.conf
          apt-get update -y && apt-get install -y curl ca-certificates
          if ! command -v node &> /dev/null; then
            curl -fsSL https://deb.nodesource.com/setup_${{ env.NODE_VERSION }}.x | bash -
            apt-get install -y nodejs
          fi
          if ! command -v pm2 &> /dev/null; then npm install -g pm2; fi
          rm -f /tmp/prepare_env.sh
          EOF
          sudo chmod +x ${{ env.CHROOT_DIR }}/tmp/prepare_env.sh
          sudo chroot ${{ env.CHROOT_DIR }} /tmp/prepare_env.sh

      - name: 8A. [è‡ªåŠ¨åŒ–è·¯å¾„] æ ¹æ®å¼€å…³å¯åŠ¨æœåŠ¡å¹¶åŠ¨æ€æš‚åœ
        if: github.event.inputs.run_startup_script == 'true' && github.event.inputs.enable_ssh == 'false' && github.event.inputs.no_cache == 'false'
        env:
          RUNTIME_MINUTES: ${{ github.event.inputs.create_backup_on_finish == 'true' && 300 || 350 }}
        run: |
          echo "âœ… è¿›å…¥è‡ªåŠ¨åŒ–è¿è¡Œæ¨¡å¼ (Chroot æœåŠ¡)..."
          # åˆ›å»ºå°†åœ¨ Chroot ç¯å¢ƒå†…æ‰§è¡Œçš„å¯åŠ¨è„šæœ¬
          sudo tee ${{ env.CHROOT_DIR }}/tmp/startup.sh > /dev/null << 'EOF'
          #!/bin/bash
          set -e
          # --- ç¯å¢ƒè®¾ç½® ---
          export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/root/node_modules/.bin
          HOME_DIR="/root"
          echo "--- [Chroot ç¯å¢ƒå†…] å¼€å§‹æ‰§è¡Œè‡ªåŠ¨åŒ–å¯åŠ¨ä»»åŠ¡ ---"
          echo "æœåŠ¡å¯åŠ¨åˆ—è¡¨: ${SERVICES_TO_RUN}"

          # æ¸…ç†æ—§æ—¥å¿—å’ŒPM2è®°å½•
          pm2 flush
          find "${HOME_DIR}" -name "*.log" -type f -delete

          # --- è¾…åŠ©å‡½æ•° ---
          # æ£€æŸ¥ç»™å®šçš„æœåŠ¡åç§°æ˜¯å¦åœ¨è¦è¿è¡Œçš„æœåŠ¡åˆ—è¡¨ä¸­
          should_run() {
              # å¦‚æœ SERVICES_TO_RUN ä¸ºç©º, "all", æˆ–è€… "*", åˆ™è®¤ä¸ºåº”è¯¥è¿è¡Œæ‰€æœ‰æœåŠ¡
              if [[ -z "${SERVICES_TO_RUN}" || "${SERVICES_TO_RUN}" == "all" || "${SERVICES_TO_RUN}" == "*" ]]; then
                  return 0 # true
              fi
              # æ£€æŸ¥æœåŠ¡åæ˜¯å¦åœ¨é€—å·åˆ†éš”çš„åˆ—è¡¨ä¸­ (æ³¨æ„å‰åçš„é€—å·,ç¡®ä¿ç²¾ç¡®åŒ¹é…)
              if [[ ",${SERVICES_TO_RUN}," == *",$1,"* ]]; then
                  return 0 # true
              fi
              return 1 # false
          }

          # --- æœåŠ¡å¯åŠ¨é€»è¾‘ ---
          # æœåŠ¡å…³é”®è¯: launcher, redis, yunzai, loophole_webdav, napcat_tunnel, openlist, chmlfrp
          
          if should_run "launcher"; then
            (cd "${HOME_DIR}" && pm2 start ./launcher.sh --name "launcher") || echo "-> è­¦å‘Š: launcher.sh å¯åŠ¨å¤±è´¥æˆ–æœªæ‰¾åˆ°ã€‚"
          fi

          if should_run "redis"; then
            if command -v redis-server &> /dev/null; then
              redis-server --daemonize yes
            else
              echo "-> è­¦å‘Š: redis-server å‘½ä»¤æœªæ‰¾åˆ°ã€‚"
            fi
          fi

          if should_run "yunzai"; then
            (cd "${HOME_DIR}/Yunzai" && pm2 start app.js --name "yunzai-app") || echo "-> è­¦å‘Š: Yunzai å¯åŠ¨å¤±è´¥æˆ–æœªæ‰¾åˆ°ã€‚"
          fi

          if should_run "loophole_webdav"; then
            if [ -f "${HOME_DIR}/loophole/loophole" ]; then
              cd "${HOME_DIR}/loophole"
              pm2 start ./loophole --name "loophole-webdav" -- webdav ~ -u "${LOOPHOLE_WEBDAV_USER}" -p "${LOOPHOLE_WEBDAV_PASS}" --hostname "${LOOPHOLE_WEBDAV_HOSTNAME}"
              # æ£€æŸ¥æ˜¯å¦ä¹Ÿéœ€è¦å¯åŠ¨ napcat éš§é“ (ä½œä¸º loophole çš„å­æœåŠ¡)
              if should_run "napcat_tunnel"; then
                pm2 start ./loophole --name "loophole-http" -- http 6099 --hostname "${LOOPHOLE_NAPCAT_HOSTNAME}" --basic-auth-username "${NAPCATUSER}" --basic-auth-password "${NAPCATPASS}"
              fi
            else
                echo "-> è­¦å‘Š: Loophole å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°ã€‚"
            fi
          fi

          if should_run "openlist"; then
            (cd "${HOME_DIR}" && pm2 start ./openlist --name "openlist-server" -- server) || echo "-> è­¦å‘Š: openlist å¯åŠ¨å¤±è´¥æˆ–æœªæ‰¾åˆ°ã€‚"
          fi

          if should_run "chmlfrp"; then
            (cd "${HOME_DIR}/ChmlFrp" && pm2 start ./frpc --name "chml-frp" -- -c frpc.ini) || echo "-> è­¦å‘Š: ChmlFrp å¯åŠ¨å¤±è´¥æˆ–æœªæ‰¾åˆ°ã€‚"
          fi

          # ä¿å­˜ PM2 è¿›ç¨‹åˆ—è¡¨å¹¶åœ¨æ—¥å¿—ä¸­æ˜¾ç¤º
          echo "--- [Chroot ç¯å¢ƒå†…] æœåŠ¡å¯åŠ¨å®Œæˆ ---"
          pm2 save
          pm2 ls
          EOF

          sudo chmod +x ${{ env.CHROOT_DIR }}/tmp/startup.sh

          # å°†å¤–éƒ¨çš„ input å˜é‡ä½œä¸ºç¯å¢ƒå˜é‡ä¼ é€’ç»™ chroot å†…çš„è„šæœ¬å¹¶æ‰§è¡Œ
          echo "å°† 'services_to_run' è¾“å…¥ (${{ github.event.inputs.services_to_run }}) ä¼ é€’åˆ° Chroot ç¯å¢ƒä¸­..."
          sudo chroot ${{ env.CHROOT_DIR }} bash -c "export SERVICES_TO_RUN='${{ github.event.inputs.services_to_run }}'; /tmp/startup.sh"

          echo "ğŸš€ æœåŠ¡å·²æ ¹æ®å¼€å…³å¯åŠ¨ã€‚å·¥ä½œæµå°†æš‚åœ ${RUNTIME_MINUTES} åˆ†é’Ÿ..."
          sleep ${RUNTIME_MINUTES}m

      - name: 8B. [è°ƒè¯•è·¯å¾„] å¯ç”¨ SSH
        # åœ¨ 'enable_ssh' æˆ– 'no_cache' æ¨¡å¼ä¸‹å‡å¯ç”¨
        if: github.event.inputs.enable_ssh == 'true' || github.event.inputs.no_cache == 'true'
        uses: lhotari/action-upterm@v1
        with:
          limit-access-to-actor: true
          wait-timeout-minutes: ${{ github.event.inputs.no_cache == 'true' && 300 || 350 }}

      - name: 9. å¸è½½è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
        if: always()
        run: |
          sudo umount -l "${{ env.CHROOT_DIR }}/dev/pts" || true
          sudo umount -l "${{ env.CHROOT_DIR }}/dev" || true
          sudo umount -l "${{ env.CHROOT_DIR }}/proc" || true
          sudo umount -l "${{ env.CHROOT_DIR }}/sys" || true

      - name: 10. [å®‰å…¨/æé€Ÿ] åˆ›å»ºåŒå¤‡ä»½åˆ° B2 å¹¶æ¸…ç†æ—§ç‰ˆæœ¬
        # ä»…åœ¨æˆåŠŸã€éå–æ¶ˆã€ä¸”éœ€è¦å¤‡ä»½çš„æ¨¡å¼ä¸‹è¿è¡Œã€‚ä¸å†å— no_cache å½±å“ã€‚
        if: success() && !cancelled() && github.event.inputs.create_backup_on_finish == 'true'
        run: |
          echo "--- å‡†å¤‡åˆ›å»ºå¤‡ä»½ ---"
          sudo chroot ${{ env.CHROOT_DIR }} bash -c 'command -v pm2 && pm2 stop all' || true
          pm2 stop python-app || true
          rclone config create ${{ env.B2_REMOTE_NAME }} b2 account "${B2_ACCOUNT_ID}" key "${B2_ACCOUNT_KEY}"
          
          TIMESTAMP=$(date -u +'%Y%m%d-%H%M%S')
          NEW_BACKUP_FILE="${{ env.BACKUP_PREFIX }}${TIMESTAMP}.tar.zst"
          REMOTE_ROOT="${{ env.B2_REMOTE_NAME }}:${B2_BUCKET_NAME}"
          echo "æ–°å¤‡ä»½æ–‡ä»¶å: ${NEW_BACKUP_FILE}"

          EXCLUDE_OPTS="--exclude='./tmp' --exclude='./var/tmp' --exclude='./root/.cache' --exclude='./var/cache' --exclude='./var/log'"
          
          echo "--- 1. ä½¿ç”¨ zstd åˆ›å»ºå¹¶ä¸Šä¼ åˆ° B2 æ ¹ç›®å½• ---"
          sudo tar -c ${EXCLUDE_OPTS} -f - -C ${{ env.CHROOT_DIR }} . | zstd -T0 -15 -c | rclone rcat "${REMOTE_ROOT}/${NEW_BACKUP_FILE}" ${{ env.RCLONE_FLAGS }}
          echo "âœ… ä¸»å¤‡ä»½ä¸Šä¼ æˆåŠŸã€‚"

          echo "--- 2. ä½¿ç”¨ B2 Server-Side-Copy å¤åˆ¶åˆ° /${{ env.B2_BACKUP_DIR }} ç›®å½• ---"
          rclone copy "${REMOTE_ROOT}/${NEW_BACKUP_FILE}" "${REMOTE_ROOT}/${{ env.B2_BACKUP_DIR }}/" ${{ env.RCLONE_FLAGS }}
          echo "âœ… ç¬¬äºŒä»½å¤‡ä»½å·²åŒæ­¥ã€‚"

          # --- [å®‰å…¨ç§»é™¤] ä¸å†æ‰“å°ä»»ä½•å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯çš„ä¸‹è½½é“¾æ¥ ---
          echo "âœ… å¤‡ä»½æ–‡ä»¶å·²ä¸Šä¼ è‡³ Backblaze B2 çš„æ ¹ç›®å½•å’Œ /${{ env.B2_BACKUP_DIR }} ç›®å½•ã€‚"

          echo "--- 3. æ¸…ç† B2 ä¸Šçš„æ—§å¤‡ä»½ (å„ä¿ç•™${{ env.BACKUP_RETENTION_COUNT }}ä¸ªæœ€æ–°) ---"
          for a_dir in "" "${{ env.B2_BACKUP_DIR }}/"; do
            FILES_TO_DELETE=$(rclone lsjson "${REMOTE_ROOT}/${a_dir}" | jq -r '[.[] | select(.Name | test("${{ env.BACKUP_PREFIX }}.*"))] | sort_by(.ModTime) | .[:-${{ env.BACKUP_RETENTION_COUNT }}][] | .Name')
            if [[ -n "$FILES_TO_DELETE" ]]; then
              echo "åœ¨ /${a_dir} ä¸­æ¸…ç†æ—§å¤‡ä»½: $FILES_TO_DELETE"
              echo "$FILES_TO_DELETE" | xargs -I {} rclone deletefile "${REMOTE_ROOT}/${a_dir}{}"
            else
              echo "åœ¨ /${a_dir} ä¸­æ— éœ€æ¸…ç†æ—§å¤‡ä»½ã€‚"
            fi
          done

      - name: 11. æ¸…ç†è¿è¡Œå™¨æ®‹ç•™æ–‡ä»¶
        if: always()
        run: |
          echo "--- å¼€å§‹æ¸…ç†è¿è¡Œå™¨ç¯å¢ƒ ---"
          sudo rm -rf ${{ env.CHROOT_DIR }}
          if [[ -d "${{ env.PYTHON_APP_REPO_DIR }}" ]]; then rm -rf ${{ env.PYTHON_APP_REPO_DIR }}; fi
          npm cache clean --force || true
          pip cache purge || true
          echo "âœ… è¿è¡Œå™¨æ¸…ç†å®Œæˆã€‚"