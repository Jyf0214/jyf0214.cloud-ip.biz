# GitHub Action Workflow (Final, with ADB Key Injection)
name: MAA Runner

on:
  workflow_dispatch:
    inputs:
      maa_command_2:
        description: 'The MAA command to run (e.g., "roguelike Mizuki")'
        required: true
        default: 'roguelike Mizuki'

jobs:
  run-maa:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # ... (前面步骤 1 到 4 保持不变) ...

      - name: 4. Configure Rclone for Backblaze B2
        run: |
          mkdir -p ~/.config/rclone
          echo "[b2]
          type = b2
          account = ${{ secrets.B2_KEY_ID_2 }}
          key = ${{ secrets.B2_APPLICATION_KEY_2 }}
          download_url = ${{ secrets.B2_DOWNLOAD_URL_2 }}" > ~/.config/rclone/rclone.conf

      - name: 5. Download MAA Configs from B2
        run: |
          mkdir -p ~/.config/maa
          rclone sync b2:${{ secrets.B2_BUCKET_NAME_2 }}/maa-configs ~/.config/maa || true

      # --- 核心新增步骤：在连接前准备好授权密钥 ---
      - name: 5a. Restore ADB Keys for Authentication
        run: |
          mkdir -p ~/.android
          echo "${{ secrets.ADB_PRIVATE_KEY_2 }}" > ~/.android/adbkey
          echo "${{ secrets.ADB_PUBLIC_KEY_2 }}" > ~/.android/adbkey.pub
          chmod 600 ~/.android/adbkey

      # --- 您原有的连接步骤，现在应该可以成功了 ---
      - name: 6. Connect to Android Device
        env:
          ADDRESS_SECRET_2: ${{ secrets.ADDRESS_SECRET_2 }}
          PORT_SECRET_2: ${{ secrets.PORT_SECRET_2 }}
        run: |
          adb connect ${{ secrets.ADDRESS_SECRET_2 }}:${{ secrets.PORT_SECRET_2 }}
          sleep 2 # 等待连接稳定，不再需要等待手动授权
          adb devices

      - name: 7. Install MAA Core and Resources
        env:
          B2_DOWNLOAD_URL: ${{ secrets.B2_DOWNLOAD_URL_2 }}
        run: maa install

      - name: 8. Run the MAA Task
        env:
          ADDRESS_SECRET_2: ${{ secrets.ADDRESS_SECRET_2 }}
          PORT_SECRET_2: ${{ secrets.PORT_SECRET_2 }}
        run: maa ${{ github.event.inputs.maa_command_2 }}

      - name: 9. Upload Configs back to B2
        if: always()
        run: |
          echo "MAA config directory is: ~/.config/maa"
          echo "Syncing configs back to B2..."
          rclone sync ~/.config/maa b2:${{ secrets.B2_BUCKET_NAME_2 }}/maa-configs