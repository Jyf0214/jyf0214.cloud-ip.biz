# GitHub Action Workflow to run MAA-CLI (Version 5, with secrets for log masking)
name: MAA Runner

on:
  workflow_dispatch:
    inputs:
      maa_command_2:
        description: 'The MAA command to run (e.g., "rogue-like Mizuki")'
        required: true
        default: 'roguelike Mizuki'

jobs:
  run-maa:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      - name: 2. Install Dependencies (Rust, Rclone)
        run: |
          sudo apt-get update
          sudo apt-get install -y rustc cargo rclone adb

      - name: 3. Compile MAA-CLI from Source
        run: |
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          cargo install --git https://github.com/MaaAssistantArknights/maa-cli.git --bin maa --tag stable --locked

      - name: 4. Configure Rclone for Backblaze B2
        run: |
          mkdir -p ~/.config/rclone
          echo "[b2]
          type = b2
          account = ${{ secrets.B2_KEY_ID_2 }}
          key = ${{ secrets.B2_APPLICATION_KEY_2 }}
          download_url = ${{ secrets.B2_DOWNLOAD_URL_2 }}" > ~/.config/rclone/rclone.conf

      - name: 5. Download MAA Configs from B2
        env:
          ADDRESS_SECRET_2: ${{ secrets.ADDRESS_SECRET_2 }}
          PORT_SECRET_2: ${{ secrets.PORT_SECRET_2 }}
        run: |
          mkdir -p ~/.config/maa
          # 从B2拉取包含您真实IP和端口的配置文件
          rclone sync b2:${{ secrets.B2_BUCKET_NAME_2 }}/maa-configs ~/.config/maa || true
          adb connect ${{ secrets.ADDRESS_SECRET_2 }}:${{ secrets.PORT_SECRET_2 }}
          sleep 5
          adb connect ${{ secrets.ADDRESS_SECRET_2 }}:${{ secrets.PORT_SECRET_2 }}

      - name: 6. Install MAA Core and Resources
        env:
          B2_DOWNLOAD_URL: ${{ secrets.B2_DOWNLOAD_URL_2 }}
        run: maa install

      - name: 7. Run the MAA Task
        # --- 核心改动：在此处加入 Secrets 
        # 将 Secrets 加载到环境变量中，这样 GitHub Actions 的日志系统
        # 就会自动检测并屏蔽任何与这些 Secrets 匹配的文本输出。
        env:
          ADDRESS_SECRET_2: ${{ secrets.ADDRESS_SECRET_2 }}
          PORT_SECRET_2: ${{ secrets.PORT_SECRET_2 }}
        run: maa ${{ github.event.inputs.maa_command_2 }}

      - name: 8. Upload Configs 
        if: always()
        run: |
          echo "MAA config directory is: ~/.config/maa"
          rm -rf ~/.config/maa